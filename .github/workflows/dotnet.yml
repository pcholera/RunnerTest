name: Build

on: push

env:
  projectName: "RunnerTest"
  devAppPoolName: "DefaultAppPool"
  devDargetLocation: "C:\\Hartree\\Sites\\RunnerTest"

jobs:
  build:
    name: Build Job
    runs-on: self-hosted

    outputs:
      branchName: ${{ steps.split.outputs._0 }}
      assemblyVersion: ${{ steps.buildNumber.outputs.number }}
      allowDevDeployment: ${{ secrets.ALLOW_DEV_DEPLOY }}

    steps:
    - uses: actions/checkout@v2

    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 5.0.x

    - name: Generate Build Version Number
      id: versionNumber
      uses: einaregilsson/build-number@v3
      with:
        token: ${{secrets.github_token}}

    - uses: rishabhgupta/split-by@v1
      id: split
      with:
          string: ${{ github.ref_name }}
          split-by: '/'

    - name : Get Release Version Number
      id: buildNumber
      run: |
        if ( "${{ steps.split.outputs._0 }}" -eq "release" ){
          echo "::set-output name=number::${{ steps.split.outputs._1 }}.${{ steps.versionNumber.outputs.build_number }}" ;
        }
        else {
          echo "::set-output name=number::0.0.${{ steps.versionNumber.outputs.build_number }}" ; 
        }

    - name: "Print Major Minor Version"
      run: echo "Version = ${{ steps.buildNumber.outputs.number }}"

    - name: Restore dependencies
      run: dotnet restore ${{ env.projectName }}\${{ env.projectName }}.csproj

    - name: Build
      run: dotnet build ${{ env.projectName }}\${{ env.projectName }}.csproj --configuration Release --no-restore

    - name: Test
      run: dotnet test RunnerTestProject\RunnerTestProject.csproj --filter Category!=Integration --configuration Release --no-restore

    - name: Publish
      if: steps.split.outputs._0 == 'main' || steps.split.outputs._0 == 'release' || steps.split.outputs._0 == 'hotfix'
      run: dotnet publish ${{ env.projectName }}\${{ env.projectName }}.csproj --configuration Release --no-restore --output .\Publish /p:AssemblyVersion=${{ steps.buildNumber.outputs.number }}

    - name: Upload Artifacts
      if: steps.split.outputs._0 == 'main' || steps.split.outputs._0 == 'release' || steps.split.outputs._0 == 'hotfix'
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.projectName }} - ${{ steps.buildNumber.outputs.number }}
        path: .\Publish

  deploy_to_dev:
    name: Deploy To Dev
    needs: build
    if: needs.build.outputs.branchName == 'main' && needs.build.outputs.allowDevDeployment == 'true'
    runs-on: self-hosted
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.projectName }} - ${{ needs.build.outputs.assemblyVersion }}
          path: .\Publish_Artifacts

      - name: Stop App Pool
        run: .\DeploymentScript\StopAppPool.ps1 ${{ env.devAppPoolName }} 

      - name: Publish File To Server
        run: |
          Remove-Item -Recurse "${{ env.devDargetLocation }}"
          Copy-Item -Path .\Publish_Artifacts -Destination "${{ env.devDargetLocation }}" -recurse -Force

      - name: Start App Pool
        run: .\DeploymentScript\StartAppPool.ps1 ${{ env.devAppPoolName }}
